import pandas as pd
from connect2 import copy_from_file
#need 
#     CPE - Vendors/Products
#     Reference List - Domains/Resources
#     CWE

def get_data(path):
    pdf = pd.read_json(path)
    
    xdf = pdf['CVE_Items'].to_dict()
    #Return ydf
    ydf = pd.DataFrame(columns={'cve_id'})

    #temp = 0
    for i in xdf.keys():
        #temp += 1
        #if temp > 10:
            #break

        cve_id = xdf[i]['cve']['CVE_data_meta']['ID']
        #cve_date = xdf[i]['publishedDate']

        try:
            #cwe_id = xdf[i]['cve']['problemtype']['problemtype_data'][0]['description'][0]['value']
            cve_description = xdf[i]['cve']['description']['description_data'][0]['value']
            #if "** REJECT **" in cve_description:
            if "REJECT" in cve_description:
                continue
        except IndexError:
            pass

        reference_list  = xdf[i]['cve']['references']['reference_data']
        #need ref source and tags
        reference_source = [] 
        reference_tag = [] 
        for ref in reference_list:                           
            reference_tag.append(' '.join(ref['tags']))
            reference_source.append(ref['refsource'])
        
        reference_tag = list(set(reference_tag))
        reference_source = list(set(reference_source))
        reference_tag =' '.join(reference_tag)
        reference_source =' '.join(reference_source)

        cpe_vendors = []
        cpe_products = []
        def get_cpe(nd): 
            if len(nd['children']) > 0:
                # not empty
                for child in nd['children']:
                    get_cpe(child)
            else:
                # empty and base case
                for match in nd['cpe_match']:
                    cpe_str = match['cpe23Uri'].replace('\\', '')
                    cpe_str = cpe_str.split('*', 1)[0]
                    cpe_word = cpe_str.rsplit(':')
                    cpe_word.remove('cpe')
                    cpe_word.remove('2.3')
                    cpe_vendors.append(cpe_word[1])
                    cpe_products.append(cpe_word[2])               


        nodes_list = xdf[i]['configurations']['nodes']

        for node in nodes_list:
            get_cpe(node)
        
        cpe_vendors = list(set(cpe_vendors))
        cpe_products = list(set(cpe_products))
        cpe_vendors =' '.join(cpe_vendors)  
        cpe_products =' '.join(cpe_products)
        
        if len(reference_tag) == 0:
            reference_tag+='na'
        
        container = {'cve_id': cve_id,
                    'reference_tag': reference_tag,
                    'reference_source': reference_source,
                    'cpe_products': cpe_products,
                    'cpe_vendors': cpe_vendors
                    }

        ydf = ydf.append(container, ignore_index=True)
    return ydf

df2015 = get_data('nvdcve-1.1-2015.json')
df2016 = get_data('nvdcve-1.1-2016.json')

#print(df2015)
#print(df2016)

frames = [df2015, df2016]  
result = pd.concat(frames)
print(result)
#df2015.to_csv('df2015_tfidf.csv')
copy_from_file(result, 'tfidf_nvd_2015_2016')
#print(df2015)
#print(ydf)
#ydf.to_csv('nvd2015_no_cpe.csv', sep= "\\")

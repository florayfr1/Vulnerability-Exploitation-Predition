import pandas as pd
import psycopg2


def gen_df(rows, cols, tablename, conn):
    if isinstance(cols, list):
        return pd.DataFrame(data=rows, columns=cols)
    else:
        temp = []
        x = cols.split(",") #error
        for i in x:
            temp.append(i.split()[-1])
        return pd.DataFrame(data=rows, columns=temp)


def get(table_name, cols='*', where=None, modifier=None, database='NVD'):
    q = df = None

    try:
        connection = psycopg2.connect(
            host='localhost',  # host on which the database is running
            database=database,  # name of the database to connect to
            user='postgres',  # username to connect with
            password='13922130490Yf'  # insert your password here
        )
    except:
        print('Connection failed...')
        pass

    else:
        cursor = connection.cursor()
        if where == None and modifier == None:
            q = f'SELECT {cols} FROM {table_name};'
        elif where != None and modifier == None:
            q = f'SELECT {cols} FROM {table_name} where {where};'
        elif where == None and modifier != None:
            q = f'SELECT {cols} FROM {table_name} {modifier};'
        else:
            q = f'SELECT DISTINCT * FROM {table_name} WHERE {where} {modifier};'

        print(f'Firing ...{q}')
        cursor.execute(q)
        rows = cursor.fetchall()
        colnames = [desc[0] for desc in cursor.description]
        df = gen_df(rows, colnames, table_name, connection)
        #??no close for cursor?
        #cursor.close()
        connection.close()
        return df

def copy_from_file(df, table):

    para = '''cve_id text,
            reference_tag text,
            reference_source text,
            cpe_products text,
            cpe_vendors text'''

    """
    Here we are going save the dataframe on disk as 
    a csv file, load the csv file  
    and use copy_from() to copy it to the table
    """
    try:
        conn = psycopg2.connect(
            host='localhost',  # host on which the database is running
            database='NVD',  # name of the database to connect to
            user='postgres',  # username to connect with
            password='13922130490Yf'  # insert your password here
        )
    except:
        print('Connection failed...')
        pass

    # Save the dataframe to disk
    tmp_df = "tmp_dataframe.csv"
    df.to_csv(tmp_df, index_label='id', header=False, index = False)
    f = open(tmp_df, 'r')
    cursor = conn.cursor()
    try:

        cursor.execute(f"DROP TABLE IF EXISTS {table};")
        
        sql = f'''CREATE TABLE {table}(
            {para}
        )'''
        
        # Creating a table
        cursor.execute(sql)
        print(f"{table} is created successfully................")

        cursor.copy_from(f, table, sep=",")
        conn.commit()
    except (Exception, psycopg2.DatabaseError) as error:
        print("Error: %s" % error)
        conn.rollback()
        cursor.close()
        return 1
    print("copy_from_file() done")
    cursor.close()


def create_table(table,para):
    
    try:
        conn = psycopg2.connect(
            host='localhost',  # host on which the database is running
            database='NVD',  # name of the database to connect to
            user='postgres',  # username to connect with
            password='13922130490Yf'  # insert your password here
        )
    except:
        print('Connection failed...')
        pass

    cursor = conn.cursor()
    try:

        cursor.execute(f"DROP TABLE IF EXISTS {table};")
        
        sql = f'''CREATE TABLE {table}(
            {para}
        )'''
            
        # Creating a table
        cursor.execute(sql)
        print("{table} is created successfully................")
    except:
        pass

def change_table(sql):
    
    try:
        conn = psycopg2.connect(
            host='localhost',  # host on which the database is running
            database='NVD',  # name of the database to connect to
            user='postgres',  # username to connect with
            password='13922130490Yf'  # insert your password here
        )
    except:
        print('Connection failed...')
        pass

    cursor = conn.cursor()
    try:
        cursor.execute(sql)
        print("{sql} is firing................")
    except:
        print("{sql} ERROR ................")
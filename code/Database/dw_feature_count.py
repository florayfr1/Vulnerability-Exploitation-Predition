from numpy.core.numeric import NaN
from pandas.core.frame import DataFrame
from connect import get, copy_from_file
import pandas as pd
from matplotlib import pyplot as plt
from datetime import timedelta, date
import random as rd


cols = '*'
tbl = 'all_dw_2015_2016'
tb2 = 'testing_set'
tb3 = 'training_set'
modifier = None
where = None
dw = get(tbl, cols, where, modifier, 'CyberEvents')
testing_set = get(tb2, cols, where, modifier)
training_set = get(tb3, cols, where, modifier)

'''
for cve in testing
    select count(distinct uid) from dw where dw.vuln_id = testing.cve
    every match -> [] if uid not in list, -> append
    dict['cve-id'] 

dw
  vulnerabilityid text,
  forumsid text,
  itemdescription text,
  marketplaceid text,
  originaltext text,
  postcontent text,
  uid text
'''

testvals = testing_set['cve_id'].tolist()
newdata = []
newdata2 = []
for i in range(len(testvals)):
    print(f'{i+1} out of {len(testvals)}')

    temp = []
    cve = testvals[i].lower()
    temp = dw[dw['vulnerabilityid'].str.contains(cve)]['uid'].tolist()
    
    temp2 = dw[dw['vulnerabilityid'].str.contains(cve, na=False)]['postcontent'].tolist()

    # logic to remove duplicates
    temp = list(set(temp))
    temp2 = list(set(temp2))
    newdata.append(len(temp))
    newdata2.append(len(temp2))

testing_set['dw_users'] = newdata
testing_set['dw_post'] = newdata2

copy_from_file(testing_set, 'testing_set_dw')

print("Training set")

trainvals = training_set['cve_id'].tolist()
newdata = []
newdata2 = []
for i in range(len(trainvals)):
    print(f'{i+1} out of {len(trainvals)}')

    temp = []
    cve = trainvals[i].lower()
    temp = dw[dw['vulnerabilityid'].str.contains(cve)]['uid'].tolist()
    temp2 = dw[dw['vulnerabilityid'].str.contains(cve, na=False)]['postcontent'].tolist()

    # logic to remove duplicates
    temp = list(set(temp))
    temp2 = list(set(temp2))
    newdata.append(len(temp))
    newdata2.append(len(temp2))

training_set['dw_users'] = newdata
training_set['dw_post'] = newdata2
copy_from_file(training_set, 'training_set_dw')

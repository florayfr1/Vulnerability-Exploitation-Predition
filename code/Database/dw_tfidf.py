
from connect import get
import pandas as pd

cols = '*'
tbl = 'all_dw_2015_2016'
tb2 = 'testing_final'
tb3 = 'training_final'
modifier = None
where = None
dw = get(tbl, cols, where, modifier, 'CyberEvents')
testing_set = get(tb2, cols, where, modifier)
training_set = get(tb3, cols, where, modifier)

'''
for cve in testing
    select count(distinct uid) from dw where dw.vuln_id = testing.cve
    every match -> [] if uid not in list, -> append
    dict['cve-id'] 

dw
  vulnerabilityid text,
  forumsid text,
  itemdescription text,
  marketplaceid text,
  originaltext text,
  postcontent text,
  uid text
'''

testvals = testing_set['cve_id'].tolist()
newdata = []
#newdata1 = []
newdata2 = []
for i in range(len(testvals)):


    print(f'{i+1} out of {len(testvals)}')

    temp = []
    cve = testvals[i].lower()
    temp = dw[dw['vulnerabilityid'].str.contains(cve)]['postcontent'].tolist()
    #temp1 = dw[dw['vulnerabilityid'].str.contains(cve)]['originaltext'].tolist()
    
    temp2 = dw[dw['vulnerabilityid'].str.contains(cve, na=False)]['itemdescription'].tolist()

    # logic to remove duplicates
    temp = list(set(temp))
    #temp1 = list(set(temp1))
    temp2 = list(set(temp2))

    while('' in temp) :
        temp.remove('')
    while(None in temp) :
        temp.remove(None)
    while('nan' in temp) :
        temp.remove('nan')

    '''while('' in temp1) :
        temp1.remove('')
    while(None in temp1) :
        temp1.remove(None)
    while('nan' in temp1) :
        temp1.remove('nan')'''

    while('' in temp2) :
        temp2.remove('')
    while(None in temp2) :
        temp2.remove(None)
    while('nan' in temp2) :
        temp2.remove('nan')

    temp = ''.join(e for e in temp if e.isalnum())
    #temp1 = ''.join(e for e in temp if e.isalnum())
    temp2 = ''.join(e for e in temp2 if e.isalnum())


    if len(temp) == 0:
        temp="na"
    #if len(temp1) == 0:
    #    temp1="na"
    if len(temp2) == 0:
        temp2="na"    

    newdata.append(temp)
    #newdata1.append(temp1)
    newdata2.append(temp2)

#" ".join(newdata)
#" ".join(newdata2)
testing_set['dw_post_content'] = newdata
#testing_set['dw_original_text'] = newdata1
testing_set['dw_market_item'] = newdata2

testing_set.to_csv('testing_final.csv')
#copy_from_file(testing_set, 'testing_final')


#----------------------------------------------------------------------------
print("Training set")

testvals = training_set['cve_id'].tolist()
newdata = []
#newdata1 = []
newdata2 = []
for i in range(len(testvals)):
    
    print(f'{i+1} out of {len(testvals)}')

    temp = []
    cve = testvals[i].lower()
    temp = dw[dw['vulnerabilityid'].str.contains(cve)]['postcontent'].tolist()
    #temp1 = dw[dw['vulnerabilityid'].str.contains(cve)]['originaltext'].tolist()
    temp2 = dw[dw['vulnerabilityid'].str.contains(cve, na=False)]['itemdescription'].tolist()

    # logic to remove duplicates
    temp = list(set(temp))
    #temp1 = list(set(temp1))
    temp2 = list(set(temp2))

    while('' in temp) :
        temp.remove('')
    while(None in temp) :
        temp.remove(None)
    while('nan' in temp) :
        temp.remove('nan')

    '''while('' in temp1) :
        temp1.remove('')
    while(None in temp1) :
        temp1.remove(None)
    while('nan' in temp1) :
        temp1.remove('nan')'''

    while('' in temp2) :
        temp2.remove('')
    while(None in temp2) :
        temp2.remove(None)
    while('nan' in temp2) :
        temp2.remove('nan')

    temp = ''.join(e for e in temp if e.isalnum())
    #temp1 = ''.join(e for e in temp if e.isalnum())
    temp2 = ''.join(e for e in temp2 if e.isalnum())


    if len(temp) == 0:
        temp="na"
    #if len(temp1) == 0:
    #    temp1="na"
    if len(temp2) == 0:
        temp2="na"    

    newdata.append(temp)
    #newdata1.append(temp1)
    newdata2.append(temp2)

#" ".join(newdata)
#" ".join(newdata2)
training_set['dw_post_content'] = newdata
#training_set['dw_original_text'] = newdata1
training_set['dw_market_item'] = newdata2

training_set.to_csv('training_final.csv')